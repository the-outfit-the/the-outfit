<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>The Outfit - Lookbook</title>
<style>
:root{
  --bg:#050507;
  --card:#0b0c10;
  --border:rgba(255,255,255,.08);
  --text-main:#f5f5f4;
  --text-soft:#a1a1aa;
  --accent:#e6c27a;
  --shadow: 0 30px 80px rgba(0,0,0,.9),0 0 0 1px rgba(255,255,255,.02);
  --ease: cubic-bezier(.2,.8,.2,1);
}
*{box-sizing:border-box;}
html,body{height:100%;}
body{
  margin:0;
  background:radial-gradient(circle at top,#20202a 0,#050507 40%),#050507;
  color:var(--text-main);
  font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",system-ui,sans-serif;
}

.topbar{
  position:sticky;top:0;z-index:10;
  background:rgba(5,5,7,.96);
  backdrop-filter:blur(14px);
  border-bottom:1px solid rgba(255,255,255,.06);
  padding:12px 28px;
  display:flex;justify-content:space-between;align-items:center;
}
.brand{display:flex;flex-direction:column;}
.brand-mark{font-size:11px;letter-spacing:.32em;text-transform:uppercase;color:var(--text-soft);}
.brand-title{font-size:20px;letter-spacing:.22em;text-transform:uppercase;}

.nav-right{
  font-size:11px;color:var(--text-soft);text-align:right;
  display:flex;flex-direction:column;gap:8px;align-items:flex-end;
}
.nav-right a{
  color:var(--accent);text-decoration:none;margin-left:14px;
  border-bottom:1px solid transparent;padding-bottom:1px;
  transition:border-color .2s var(--ease), opacity .2s var(--ease);
}
.nav-right a:hover{border-bottom-color:var(--accent);opacity:.9;}

.container{max-width:1120px;margin:22px auto 40px;padding:0 24px;}
.header-row{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:18px;}
.header-row h2{margin:0;font-size:16px;font-weight:500;letter-spacing:.26em;text-transform:uppercase;}
.header-row .sub{font-size:11px;color:var(--text-soft);}

.posts{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:28px;}
.post{border-radius:22px;overflow:hidden;}
.post-inner{
  position:relative;
  background:var(--card);
  border-radius:22px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  padding:10px;
  height:100%;
  display:flex;flex-direction:column;
  transform:translateZ(0);
  transition:transform .35s var(--ease), box-shadow .35s var(--ease), border-color .35s var(--ease), filter .35s var(--ease);
}

/* 上品ホバー */
.post-inner:hover{
  transform:translateY(-4px);
  border-color:rgba(230,194,122,.22);
  box-shadow: 0 40px 120px rgba(0,0,0,.92), 0 0 0 1px rgba(230,194,122,.08);
}

/* 光のスイープ */
.post-inner::before{
  content:"";
  position:absolute;inset:-1px;
  border-radius:22px;
  pointer-events:none;
  background:linear-gradient(120deg, transparent 0%, rgba(230,194,122,.06) 20%, transparent 40%);
  transform:translateX(-60%);
  opacity:0;
  transition:opacity .3s var(--ease);
}
.post-inner:hover::before{
  opacity:1;
  animation:sweep 1.2s var(--ease) 1;
}
@keyframes sweep{
  0%{transform:translateX(-60%);}
  100%{transform:translateX(60%);}
}

/* 枠固定 */
.post-img-wrap{
  position:relative;
  border-radius:18px;overflow:hidden;margin-bottom:10px;
  aspect-ratio: 4 / 5;
  background:#050507;
  transform:translateZ(0);
}

/* ★写真の上に演出用レイヤー：通常は透明 */
.post-img-wrap::before,
.post-img-wrap::after{
  content:"";
  position:absolute;inset:-20%;
  pointer-events:none;
  opacity:0;
  transition:opacity .2s var(--ease);
}

/* 画像本体 */
.post-img-wrap img{
  width:100%;height:100%;
  object-fit:cover;
  display:block;
  cursor:pointer;
  transform:scale(1);
  transition:transform .6s var(--ease), filter .6s var(--ease);
  will-change:transform, filter;
}
.post-inner:hover .post-img-wrap img{
  transform:scale(1.03);
  filter:saturate(1.05) contrast(1.02);
}

.post-meta{display:flex;justify-content:space-between;align-items:flex-end;font-size:11px;margin-top:4px;}
.post-user{font-weight:500;letter-spacing:.04em;}
.post-votes{color:var(--text-soft);letter-spacing:.08em;text-transform:uppercase;}

/* 票数ポン */
.count-pop{animation:countPop .34s var(--ease) 1;}
@keyframes countPop{
  0%{transform:translateY(2px);opacity:.65;}
  60%{transform:translateY(-3px);opacity:1;}
  100%{transform:translateY(0);opacity:1;}
}

.actions{margin-top:8px;display:flex;gap:8px;align-items:center;min-height:28px;}

.btn{
  display:inline-flex;align-items:center;justify-content:center;
  padding:6px 12px;border-radius:999px;
  font-size:10px;font-weight:700;letter-spacing:.16em;text-transform:uppercase;
  border:1px solid var(--accent);
  cursor:pointer;
  transition:transform .18s var(--ease), filter .2s var(--ease), background .25s var(--ease), color .25s var(--ease), opacity .25s var(--ease);
  position:relative;
  user-select:none;
}
.btn:active{transform:translateY(1px) scale(.99);}
.btn-vote{background:transparent;color:var(--accent);text-decoration:none;}
.btn-unvote{background:var(--accent);color:#050507;text-decoration:none;}
.btn-logout{background:transparent;color:var(--accent);border:1px solid var(--accent);}

.btn::after{
  content:"";
  position:absolute;inset:0;border-radius:999px;
  background:linear-gradient(120deg, transparent 0%, rgba(255,255,255,.22) 18%, transparent 36%);
  transform:translateX(-80%);
  opacity:0;
  pointer-events:none;
}
.btn:hover::after{
  opacity:.9;
  animation:btnSweep 1.05s var(--ease) 1;
}
@keyframes btnSweep{
  0%{transform:translateX(-80%);}
  100%{transform:translateX(80%);}
}

.btn-loading{opacity:.65;cursor:progress;pointer-events:none;}

/* 投票成功：カードが一瞬“発光＆浮く” */
.vote-flash{animation:voteFlash .55s var(--ease) 1;}
@keyframes voteFlash{
  0%{transform:translateY(0);box-shadow:var(--shadow);border-color:rgba(230,194,122,.12);}
  45%{transform:translateY(-6px);box-shadow: 0 55px 160px rgba(0,0,0,.95), 0 0 0 1px rgba(230,194,122,.16), 0 0 40px rgba(230,194,122,.08);border-color:rgba(230,194,122,.28);}
  100%{transform:translateY(0);box-shadow:var(--shadow);border-color:var(--border);}
}

/* ============================
   ★VOTE：写真全体がふわっと光る
   ============================ */
.post-inner.vote-glow .post-img-wrap::before{
  opacity:1;
  mix-blend-mode:screen;
  background:
    radial-gradient(closest-side at 50% 40%, rgba(230,194,122,.35), transparent 70%),
    linear-gradient(120deg, transparent 0%, rgba(255,255,255,.16) 18%, transparent 40%);
  filter:blur(.2px);
  animation:voteGlow 820ms var(--ease) 1;
}
.post-inner.vote-glow .post-img-wrap img{
  filter:saturate(1.12) contrast(1.04) brightness(1.07);
}
@keyframes voteGlow{
  0%{transform:translateY(12px) scale(.98); opacity:0;}
  28%{opacity:1;}
  100%{transform:translateY(-10px) scale(1.02); opacity:0;}
}

/* ============================
   ★UNVOTE：わかりやすく寂しい演出
   暗転 + 彩度落ち + 沈む + “VOID”スタンプ
   ============================ */
.post-inner.unvote-sad{
  animation:unvoteDrop 620ms var(--ease) 1;
}
@keyframes unvoteDrop{
  0%{transform:translateY(0);}
  35%{transform:translateY(8px);}
  100%{transform:translateY(0);}
}

/* 画像自体を“寂しく” */
.post-inner.unvote-sad .post-img-wrap img{
  filter:grayscale(.25) saturate(.55) contrast(.98) brightness(.84);
  transform:scale(.995);
}

/* 暗いビネット＋うっすら粒感（上品に） */
.post-inner.unvote-sad .post-img-wrap::after{
  opacity:1;
  background:
    radial-gradient(closest-side at 50% 50%, transparent 40%, rgba(0,0,0,.55) 100%),
    linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.40));
  animation:unvoteVignette 760ms var(--ease) 1;
}
@keyframes unvoteVignette{
  0%{transform:scale(1.04); opacity:0;}
  30%{opacity:1;}
  100%{transform:scale(1); opacity:0;}
}

/* “VOID”スタンプ（短時間） */
.unvote-stamp{
  position:absolute;
  top:16px; right:16px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(5,5,7,.45);
  color:rgba(245,245,244,.82);
  font-size:10px;
  letter-spacing:.22em;
  text-transform:uppercase;
  backdrop-filter:blur(10px);
  transform:rotate(-7deg) translateY(6px);
  opacity:0;
  pointer-events:none;
  animation:stamp 980ms var(--ease) 1;
}
@keyframes stamp{
  0%{opacity:0; transform:rotate(-7deg) translateY(10px) scale(.98);}
  18%{opacity:1;}
  70%{opacity:1;}
  100%{opacity:0; transform:rotate(-7deg) translateY(0) scale(1);}
}

/* ゲスト案内 */
.note{margin-top:10px;color:var(--text-soft);font-size:11px;}
.empty{margin-top:40px;text-align:center;font-size:13px;color:var(--text-soft);}
@media (max-width:768px){.container{padding:0 16px;}.posts{grid-template-columns:1fr;gap:20px;}}

/* ルックブック */
.lookbook-overlay{
  position:fixed;inset:0;padding:24px;
  background:rgba(5,5,7,.92);
  backdrop-filter:blur(10px);
  display:flex;justify-content:center;align-items:center;
  opacity:0;pointer-events:none;
  transition:opacity .22s var(--ease);
  z-index:999;
}
.lookbook-overlay.show{opacity:1;pointer-events:auto;}
.lookbook-inner{
  width:100%;height:100%;
  display:flex;flex-direction:column;
  justify-content:center;align-items:center;
  gap:10px;
  transform:scale(.985);
  transition:transform .28s var(--ease);
}
.lookbook-overlay.show .lookbook-inner{transform:scale(1);}
.lookbook-image-wrap{
  width:min(92vw, 1100px);
  height:auto;
  max-height:calc(100vh - 160px);
  display:flex;justify-content:center;align-items:center;
  overflow:hidden;
  border-radius:20px;
  border:1px solid rgba(255,255,255,0.12);
  box-shadow:0 45px 140px rgba(0,0,0,0.92);
  background:#050507;
}
.lookbook-image-wrap img{
  display:block;
  width:100%;
  height:auto;
  max-height:calc(100vh - 160px);
  object-fit:contain;
  image-rendering:auto;
}
.lookbook-credit{font-size:11px;color:var(--text-soft);text-transform:uppercase;letter-spacing:.12em;text-align:center;}
.lookbook-hint{margin-top:2px;font-size:10px;color:var(--text-soft);text-align:center;}
@media (max-width:768px){
  .lookbook-overlay{padding:16px;}
  .lookbook-image-wrap{width:min(94vw, 980px); max-height:calc(100vh - 140px);}
  .lookbook-image-wrap img{max-height:calc(100vh - 140px);}
}

/* トースト */
.toast{
  position:fixed;
  right:18px;
  bottom:18px;
  background:rgba(11,12,16,.88);
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  padding:10px 12px;
  box-shadow:0 30px 80px rgba(0,0,0,.7);
  backdrop-filter:blur(10px);
  color:var(--text-main);
  font-size:11px;
  letter-spacing:.08em;
  opacity:0;
  transform:translateY(10px);
  pointer-events:none;
  transition:opacity .22s var(--ease), transform .22s var(--ease);
  z-index:1000;
}
.toast.show{opacity:1;transform:translateY(0);}
.toast .small{display:block;color:var(--text-soft);font-size:10px;letter-spacing:.06em;margin-top:2px;}

form.inline{display:inline;margin:0;}

@media (prefers-reduced-motion: reduce){
  *{animation:none !important;transition:none !important;}
}
</style>
</head>
<body>

<div class="topbar">
  <div class="brand">
    <div class="brand-mark">THE OUTFIT</div>
    <div class="brand-title">LOOKBOOK</div>
  </div>

  <div class="nav-right">
    {% if is_logged_in %}
      <div>{{ user }}</div>
      <div>
        <a href="{{ url_for('upload') }}">UPLOAD</a>
        <form class="inline" method="post" action="{{ url_for('logout') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <button class="btn btn-logout" type="submit">LOGOUT</button>
        </form>
      </div>
    {% else %}
      <div>GUEST</div>
      <div>
        <a href="{{ url_for('login', next='/') }}">LOGIN</a>
        <a href="{{ url_for('register') }}">REGISTER</a>
      </div>
    {% endif %}
  </div>
</div>

<div class="container">
  <div class="header-row">
    <h2>RANKED LOOKS</h2>
    <div class="sub">CURATED BY VOTES · LIVE FEED</div>
  </div>

  {% if not is_logged_in %}
    <div class="note">投票・投稿は <a href="{{ url_for('login', next='/') }}" style="color:var(--accent);text-decoration:none;">ログイン</a> 後にできます。</div>
  {% endif %}

  {% if posts %}
  <div class="posts">
    {% for p in posts %}
    <div class="post" data-post-id="{{ p['id'] }}">
      <div class="post-inner" id="card-{{ p['id'] }}">
        <div class="post-img-wrap">
          <img
            src="{{ url_for('uploaded_file', filename=p['filename']) }}"
            class="look-img"
            data-user="{{ p['user'] }}"
            data-votes="{{ p['votes'] }}"
            alt="outfit"
            loading="lazy"
          >
        </div>

        <div class="post-meta">
          <div class="post-user">{{ p['user'] }}</div>
          <div class="post-votes" id="votes-{{ p['id'] }}">{{ p['votes'] }} VOTES</div>
        </div>

        <div class="actions" id="actions-{{ p['id'] }}">
          {% if is_logged_in %}
            {% if p['id'] in voted_ids %}
              <form class="inline vote-form"
                    method="post"
                    action="{{ url_for('unvote', post_id=p['id']) }}"
                    data-vote-url="{{ url_for('vote', post_id=p['id']) }}"
                    data-unvote-url="{{ url_for('unvote', post_id=p['id']) }}"
                    data-voted="1">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button class="btn btn-unvote" type="submit">REMOVE VOTE</button>
              </form>
            {% else %}
              <form class="inline vote-form"
                    method="post"
                    action="{{ url_for('vote', post_id=p['id']) }}"
                    data-vote-url="{{ url_for('vote', post_id=p['id']) }}"
                    data-unvote-url="{{ url_for('unvote', post_id=p['id']) }}"
                    data-voted="0">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button class="btn btn-vote" type="submit">VOTE</button>
              </form>
            {% endif %}
          {% else %}
            <a class="btn btn-vote" href="{{ url_for('login', next='/') }}">VOTE</a>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
    <p class="empty">No looks yet. Be the first to curate your page.</p>
  {% endif %}
</div>

<div class="lookbook-overlay" id="lookbookOverlay">
  <div class="lookbook-inner">
    <div class="lookbook-image-wrap">
      <img id="lookbookImage" src="" alt="look">
    </div>
    <div class="lookbook-credit" id="lookbookCredit"></div>
    <div class="lookbook-hint">CLICK ANYWHERE TO CLOSE</div>
  </div>
</div>

<div class="toast" id="toast">
  <span id="toastMain">UPDATED</span>
  <span class="small" id="toastSub">Your lookbook is live.</span>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // ---------- Lookbook ----------
  const imgs = document.querySelectorAll(".look-img");
  const overlay = document.getElementById("lookbookOverlay");
  const overlayImg = document.getElementById("lookbookImage");
  const overlayCredit = document.getElementById("lookbookCredit");

  imgs.forEach(function (img) {
    img.addEventListener("click", function () {
      overlayImg.src = img.getAttribute("src");
      const user = img.getAttribute("data-user") || "";
      const votes = img.getAttribute("data-votes") || "";
      overlayCredit.textContent = user + (votes !== "" ? " · " + votes + " VOTES" : "");
      overlay.classList.add("show");
    });
  });
  overlay.addEventListener("click", function () {
    overlay.classList.remove("show");
  });

  // ---------- Toast ----------
  const toast = document.getElementById("toast");
  const toastMain = document.getElementById("toastMain");
  const toastSub = document.getElementById("toastSub");
  let toastTimer = null;

  function showToast(main, sub) {
    toastMain.textContent = main;
    toastSub.textContent = sub;
    toast.classList.add("show");
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove("show"), 1650);
  }

  // ---------- Helpers ----------
  function popCount(el){
    if (!el) return;
    el.classList.remove("count-pop");
    void el.offsetWidth;
    el.classList.add("count-pop");
  }

  function flashCard(postId){
    const card = document.getElementById(`card-${postId}`);
    if (!card) return;
    card.classList.remove("vote-flash");
    void card.offsetWidth;
    card.classList.add("vote-flash");
  }

  function voteGlow(postId){
    const card = document.getElementById(`card-${postId}`);
    if (!card) return;
    card.classList.remove("vote-glow");
    void card.offsetWidth;
    card.classList.add("vote-glow");
    setTimeout(() => card.classList.remove("vote-glow"), 900);
  }

  function unvoteSad(postId){
    const card = document.getElementById(`card-${postId}`);
    if (!card) return;

    // VOIDスタンプを一瞬だけ出す
    const stamp = document.createElement("div");
    stamp.className = "unvote-stamp";
    stamp.textContent = "VOID";
    card.appendChild(stamp);
    setTimeout(() => stamp.remove(), 1050);

    card.classList.remove("unvote-sad");
    void card.offsetWidth;
    card.classList.add("unvote-sad");
    setTimeout(() => card.classList.remove("unvote-sad"), 900);
  }

  // ---------- Vote (AJAX) ----------
  const voteForms = document.querySelectorAll(".vote-form");

  voteForms.forEach((form) => {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const btn = form.querySelector("button");
      if (btn) btn.classList.add("btn-loading");

      try {
        const res = await fetch(form.action, {
          method: "POST",
          headers: { "Accept": "application/json", "X-Requested-With": "fetch" },
          body: new FormData(form),
          credentials: "same-origin"
        });

        if (!res.ok) {
          if (btn) btn.classList.remove("btn-loading");
          form.submit();
          return;
        }

        const data = await res.json();
        if (!data || !data.ok) {
          if (btn) btn.classList.remove("btn-loading");
          form.submit();
          return;
        }

        // votes text
        const votesEl = document.getElementById(`votes-${data.post_id}`);
        if (votesEl) {
          votesEl.textContent = `${data.votes} VOTES`;
          popCount(votesEl);
        }

        // update img meta for overlay
        const wrap = document.querySelector(`.post[data-post-id="${data.post_id}"]`);
        if (wrap) {
          const img = wrap.querySelector(".look-img");
          if (img) img.setAttribute("data-votes", String(data.votes));
        }

        // toggle button
        const voted = !!data.voted;
        form.action = voted ? form.dataset.unvoteUrl : form.dataset.voteUrl;

        if (btn) {
          btn.classList.remove("btn-loading");
          if (voted) {
            btn.textContent = "REMOVE VOTE";
            btn.classList.remove("btn-vote");
            btn.classList.add("btn-unvote");
          } else {
            btn.textContent = "VOTE";
            btn.classList.remove("btn-unvote");
            btn.classList.add("btn-vote");
          }
        }

        // motion
        if (voted) {
          flashCard(data.post_id);
          voteGlow(data.post_id);              // ★写真全体が光る
          showToast("VOTED ✦", "A quiet brilliance.");
        } else {
          unvoteSad(data.post_id);             // ★はっきり寂しい
          showToast("REMOVED", "A little lonely.");
        }

      } catch (_) {
        if (btn) btn.classList.remove("btn-loading");
        form.submit();
      }
    });
  });
});
</script>

</body>
</html>
