<!DOCTYPE html>
<html lang="{{ lang_code }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>{{ t('site_name') }} - {{ t('ranked_looks') }}</title>
  <style>
    :root{
      --bg:#07070a;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.08);
      --line:rgba(255,255,255,.14);
      --text:#fff;
      --muted:rgba(255,255,255,.68);
      --muted2:rgba(255,255,255,.52);
      --accent:rgba(255,255,255,.92);
      --accent2:rgba(255,255,255,.72);
      --danger:#ff2d72;
      --radius:20px;
      --shadow:0 18px 50px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      background:
        radial-gradient(1200px 600px at 15% -10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(900px 500px at 85% 0%, rgba(255,255,255,.07), transparent 55%),
        radial-gradient(700px 400px at 60% 110%, rgba(124,60,255,.08), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .topbar{
      position:sticky; top:0; z-index:20;
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 22px;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(0,0,0,.72), rgba(0,0,0,.35));
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .brand{display:flex; flex-direction:column; gap:2px}
    .brand-mark{font-weight:800; letter-spacing:.18em; font-size:12px; color:rgba(255,255,255,.9)}
    .brand-title{font-weight:650; letter-spacing:.08em; font-size:12px; color:rgba(255,255,255,.55); text-transform:uppercase}
    .nav-right{display:flex; align-items:center; gap:12px; font-size:13px}
    .nav-right a{color:rgba(255,255,255,.86); text-decoration:none}
    .nav-right a:hover{color:#fff; text-decoration:underline}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
    }
    .lang{font-size:12px;color:rgba(255,255,255,.75);white-space:nowrap}
    .lang a{color:rgba(255,255,255,.85);text-decoration:none}
    .lang a:hover{color:#fff;text-decoration:underline}

    .btn{
      appearance:none; border:1px solid rgba(255,255,255,.16);
      border-radius:999px; padding:9px 12px;
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      font-weight:650; cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn-primary{
      background:#fff; color:#000; border-color:transparent;
    }
    .btn-primary:hover{filter:brightness(.95)}
    .btn-logout{background:transparent}

    .container{width:min(1100px, 92vw); margin:0 auto; padding:28px 0 70px}
    .hero{
      margin:18px 0 22px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:var(--radius);
      background:linear-gradient(140deg, rgba(255,255,255,.09), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .hero-inner{
      padding:22px 22px 18px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
    }
    @media (max-width:900px){
      .hero-inner{grid-template-columns:1fr}
    }
    .kicker{font-size:12px; letter-spacing:.18em; color:rgba(255,255,255,.62)}
    .hero h1{
      margin:10px 0 10px;
      font-size:32px; letter-spacing:.02em; line-height:1.12;
    }
    .hero p{margin:0; color:rgba(255,255,255,.72); font-size:14px; line-height:1.7}
    .hero .cta{display:flex; flex-wrap:wrap; gap:10px; margin-top:14px}
    .steps{
      display:grid; gap:10px; align-content:start;
      padding:18px;
      border-left:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20);
    }
    @media (max-width:900px){
      .steps{border-left:0; border-top:1px solid rgba(255,255,255,.10)}
    }
    .step{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      border-radius:16px;
      padding:12px 12px;
    }
    .step .n{font-size:11px; letter-spacing:.18em; color:rgba(255,255,255,.55)}
    .step .t{margin-top:6px; font-weight:750; letter-spacing:.06em}

    .header-row{display:flex; align-items:flex-end; justify-content:space-between; gap:14px; margin:20px 0 12px}
    .header-row h2{margin:0; font-size:18px; letter-spacing:.10em}
    .sub{color:var(--muted); font-size:12px; letter-spacing:.10em; text-transform:uppercase}

    .note{
      margin:14px 0 18px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      color:rgba(255,255,255,.80);
      font-size:13px;
    }

    .posts{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:16px;
    }
    @media (max-width:980px){ .posts{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:640px){ .posts{grid-template-columns:1fr} }

    .post{
      position:relative;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      overflow:hidden;
      box-shadow:0 16px 40px rgba(0,0,0,.55);
      transform:translateZ(0);
    }
    .post-inner{position:relative}
    .post-img-wrap{position:relative; aspect-ratio: 4/5; background:rgba(0,0,0,.45)}
    .post-img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      filter:saturate(1.05) contrast(1.03);
      cursor:zoom-in;
      transition:transform .35s ease, filter .35s ease;
    }
    .post:hover .post-img{transform:scale(1.02)}
    .meta{
      padding:14px 14px 16px;
      display:flex; flex-direction:column; gap:10px;
    }
    .meta-top{display:flex; justify-content:space-between; align-items:flex-start; gap:10px}
    .by{color:var(--muted); font-size:12px}
    .title{
      font-weight:700;
      letter-spacing:.02em;
      font-size:13px;
      color:rgba(255,255,255,.92);
      line-height:1.35;
      margin-top:4px;
    }
    .counts{
      display:flex; align-items:center; gap:10px; color:rgba(255,255,255,.80);
      font-size:12px;
    }
    .dot{opacity:.55}

    .vote-row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .vote-btn{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      font-weight:750;
      letter-spacing:.10em;
      cursor:pointer;
      transition:background .25s ease, transform .12s ease;
    }
    .vote-btn:hover{background:rgba(255,255,255,.10)}
    .vote-btn:active{transform:translateY(1px)}
    .vote-btn.primary{
      background:#fff;
      color:#000;
      border-color:transparent;
    }

    .sparkle-canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
      opacity:0;
      transition:opacity .25s ease;
      mix-blend-mode:screen;
    }
    .sparkle-active .sparkle-canvas{opacity:1}

    /* unvote dim: dark purple sink */
    .dimmed .post-img{filter:saturate(.75) brightness(.70) contrast(1.02) hue-rotate(250deg)}
    .dimmed .post{background:rgba(90,40,140,.10)}
    .dim-overlay{
      position:absolute; inset:0;
      pointer-events:none;
      background:radial-gradient(600px 360px at 50% 30%, rgba(170,80,255,.12), rgba(0,0,0,0) 55%),
                 linear-gradient(to bottom, rgba(60,0,120,.10), rgba(0,0,0,.18));
      opacity:0;
      transition:opacity .6s ease;
    }
    .dimmed .dim-overlay{opacity:1}

    /* toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:22px;
      transform:translateX(-50%) translateY(10px);
      background:rgba(0,0,0,.70);
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      padding:10px 14px;
      display:flex;
      align-items:center;
      gap:10px;
      z-index:999;
      opacity:0;
      pointer-events:none;
      transition:opacity .22s ease, transform .22s ease;
      backdrop-filter:blur(10px);
      box-shadow:0 18px 60px rgba(0,0,0,.55);
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
    .toast .k{font-weight:800; letter-spacing:.12em; font-size:11px}
    .toast .m{color:rgba(255,255,255,.80); font-size:12px}

    /* modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.88);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:200;
      padding:18px;
    }
    .modal.show{display:flex}
    .modal img{
      max-width:min(92vw, 1000px);
      max-height:88vh;
      object-fit:contain;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      box-shadow:0 22px 90px rgba(0,0,0,.65);
    }
    .modal .hint{
      position:absolute;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      color:rgba(255,255,255,.70);
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    .inline{display:inline}
    form.inline{display:inline}

    .empty{
      margin:22px 0;
      padding:18px 16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:rgba(255,255,255,.78);
      font-size:14px;
      line-height:1.6;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="brand-mark">THE OUTFIT</div>
      <div class="brand-title">{{ t('lookbook') }}</div>
    </div>

    <div class="nav-right">
      <div class="lang">
        <a href="{{ set_lang_url('ja') }}">日本語</a> / <a href="{{ set_lang_url('en') }}">EN</a>
      </div>

      {% if is_logged_in %}
        <div class="pill">
          <span style="color:rgba(255,255,255,.55);font-size:11px;letter-spacing:.12em">{{ t('guest') }}</span>
          <span style="font-weight:700">{{ user }}</span>
        </div>
        <a class="btn btn-primary" href="{{ url_for('upload') }}">{{ t('upload') }}</a>
        <form class="inline" method="post" action="{{ url_for('logout') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="btn btn-logout" type="submit">{{ t('logout') }}</button>
        </form>
      {% else %}
        <a class="btn" href="{{ url_for('login') }}">{{ t('login') }}</a>
        <a class="btn btn-primary" href="{{ url_for('register') }}">{{ t('register') }}</a>
      {% endif %}
    </div>
  </div>

  <div class="container">

    <div class="hero">
      <div class="hero-inner">
        <div>
          <div class="kicker">{{ t('intro_kicker') }}</div>
          <h1>{{ t('intro_title') }}</h1>
          <p>
            <strong>THE OUTFIT</strong>
            {% if lang_code == 'ja' %}
              {{ t('intro_desc_1') }}<strong>{{ t('intro_desc_2') }}</strong>{{ t('intro_desc_3') }}
            {% else %}
              {{ t('intro_desc_1') }}
              {{ t('intro_desc_3') }}
            {% endif %}
          </p>

          <div class="note" style="margin-top:14px">
            <div style="font-weight:800;letter-spacing:.10em;font-size:12px;margin-bottom:6px">{{ t('how_it_works') }}</div>
            <div style="color:rgba(255,255,255,.78);font-size:13px;line-height:1.65">
              <div style="margin-bottom:6px"><strong>{{ t('can_do') }}</strong></div>
              <div>• {{ t('can_view') }}</div>
              <div>• {{ t('can_vote') }}</div>
              <div>• {{ t('can_post') }}</div>
            </div>
          </div>

          <div class="cta">
            <a class="btn btn-primary" href="#ranking">{{ t('view_ranking') }}</a>
            {% if not is_logged_in %}
              <a class="btn" href="{{ url_for('login', next='/') }}">{{ t('login') }}</a>
            {% else %}
              <a class="btn" href="{{ url_for('upload') }}">{{ t('upload') }}</a>
            {% endif %}
          </div>
        </div>

        <div class="steps">
          <div class="step">
            <div class="n">STEP 01</div>
            <div class="t">{{ t('step_1') }}</div>
          </div>
          <div class="step">
            <div class="n">STEP 02</div>
            <div class="t">{{ t('step_2') }}</div>
          </div>
          <div class="step">
            <div class="n">STEP 03</div>
            <div class="t">{{ t('step_3') }}</div>
          </div>
        </div>
      </div>
    </div>

    <div id="ranking" class="header-row">
      <h2>{{ t('ranked_looks') }}</h2>
      <div class="sub">{{ t('curated_by_votes') }}</div>
    </div>

    {% if not is_logged_in %}
      <div class="note">
        {% if lang_code == 'ja' %}
          投票・投稿は <a href="{{ url_for('login', next='/') }}" style="color:rgba(255,255,255,.92);text-decoration:underline">ログイン</a> 後にできます。
        {% else %}
          <a href="{{ url_for('login', next='/') }}" style="color:rgba(255,255,255,.92);text-decoration:underline">Login</a> to vote and post.
        {% endif %}
      </div>
    {% endif %}

    {% if posts %}
      <div class="posts">
        {% for p in posts %}
          {% set voted = (p['id'] in voted_ids) %}
          <div class="post {% if voted %}sparkle-active{% endif %}" data-post-id="{{ p['id'] }}" id="post-{{ p['id'] }}">
            <div class="post-inner" id="card-{{ p['id'] }}">
              <div class="post-img-wrap">
                <img class="post-img"
                     src="{{ url_for('uploaded_file', filename=p['filename']) }}"
                     alt="outfit {{ p['id'] }}"
                     data-full="{{ url_for('uploaded_file', filename=p['filename']) }}">
                <canvas class="sparkle-canvas" id="sparkle-{{ p['id'] }}"></canvas>
                <div class="dim-overlay"></div>
              </div>

              <div class="meta">
                <div class="meta-top">
                  <div>
                    <div class="by">
                      by <span style="color:rgba(255,255,255,.88)">{{ p['user'] }}</span>
                    </div>
                    {% if p['title'] %}
                      <div class="title">{{ p['title'] }}</div>
                    {% endif %}
                  </div>
                  <div class="counts">
                    <span id="votes-{{ p['id'] }}">{{ p['votes'] }}</span>
                    <span class="dot">•</span>
                    <span>{% if lang_code == 'ja' %}票{% else %}votes{% endif %}</span>
                  </div>
                </div>

                <div class="vote-row">
                  <button
                    class="vote-btn {% if voted %}primary{% endif %}"
                    data-action="{% if voted %}unvote{% else %}vote{% endif %}"
                    data-post-id="{{ p['id'] }}"
                    type="button">
                    {% if voted %}{{ t('remove_vote') }}{% else %}{{ t('vote') }}{% endif %}
                  </button>

                  <div style="color:rgba(255,255,255,.55);font-size:11px;letter-spacing:.12em">
                    #{{ loop.index }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty">{{ t('no_looks') }}</div>
    {% endif %}
  </div>

  <div class="toast" id="toast">
    <div class="k" id="toastK">OK</div>
    <div class="m" id="toastM">Done</div>
  </div>

  <div class="modal" id="modal">
    <img id="modalImg" alt="full">
    <div class="hint">{{ t('close_hint') }}</div>
  </div>

  <script>
    const CSRF = "{{ csrf_token() }}";

    // ---------- toast ----------
    let toastTimer = null;
    function showToast(k, m) {
      const el = document.getElementById("toast");
      document.getElementById("toastK").textContent = k;
      document.getElementById("toastM").textContent = m;
      el.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => el.classList.remove("show"), 1600);
    }

    // ---------- modal ----------
    const modal = document.getElementById("modal");
    const modalImg = document.getElementById("modalImg");
    document.addEventListener("click", (e) => {
      const img = e.target.closest(".post-img");
      if (img) {
        modalImg.src = img.dataset.full;
        modal.classList.add("show");
      }
    });
    modal.addEventListener("click", () => {
      modal.classList.remove("show");
      modalImg.src = "";
    });

    // ---------- powder-snow sparkle (high brand, subtle) ----------
    function makeSparkle(canvas) {
      const ctx = canvas.getContext("2d");
      const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

      let W = 0, H = 0;
      function resize() {
        const rect = canvas.getBoundingClientRect();
        W = Math.max(1, Math.floor(rect.width));
        H = Math.max(1, Math.floor(rect.height));
        canvas.width = Math.floor(W * DPR);
        canvas.height = Math.floor(H * DPR);
        ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
      }
      resize();

      // intensity: 1/3 (fewer particles)
      const COUNT = Math.max(18, Math.floor((W * H) / 22000)); // <- reduced
      const parts = [];
      for (let i = 0; i < COUNT; i++) {
        parts.push({
          x: Math.random() * W,
          y: Math.random() * H,
          r: 0.6 + Math.random() * 1.4,
          a: 0.05 + Math.random() * 0.18,
          tw: 0.008 + Math.random() * 0.018,
          vx: -0.02 + Math.random() * 0.04,
          vy: 0.10 + Math.random() * 0.22,
          p: Math.random() * Math.PI * 2,
        });
      }

      let running = false;
      let t0 = 0;
      function tick(ts) {
        if (!running) return;
        if (!t0) t0 = ts;
        const dt = Math.min(32, ts - t0);
        t0 = ts;

        ctx.clearRect(0, 0, W, H);

        for (const p of parts) {
          p.p += p.tw * dt;
          p.x += p.vx * dt;
          p.y += p.vy * dt;

          // loop
          if (p.y > H + 10) { p.y = -10; p.x = Math.random() * W; }
          if (p.x < -10) p.x = W + 10;
          if (p.x > W + 10) p.x = -10;

          const tw = 0.4 + 0.6 * Math.abs(Math.sin(p.p));
          const alpha = p.a * tw;

          // brand-ish: white + faint champagne glint (kept subtle)
          ctx.beginPath();
          ctx.fillStyle = `rgba(255,255,255,${alpha})`;
          ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
          ctx.fill();

          ctx.beginPath();
          ctx.fillStyle = `rgba(255,245,210,${alpha * 0.35})`;
          ctx.arc(p.x + 0.6, p.y - 0.4, Math.max(0.3, p.r * 0.55), 0, Math.PI * 2);
          ctx.fill();
        }

        requestAnimationFrame(tick);
      }

      return {
        start() { if (!running) { running = true; t0 = 0; requestAnimationFrame(tick); } },
        stop() { running = false; ctx.clearRect(0, 0, W, H); },
        resize,
      };
    }

    const sparkleEngines = new Map();
    function ensureSparkle(postId) {
      const canvas = document.getElementById(`sparkle-${postId}`);
      if (!canvas) return null;
      if (!sparkleEngines.has(postId)) {
        sparkleEngines.set(postId, makeSparkle(canvas));
      }
      return sparkleEngines.get(postId);
    }

    // Start sparkle for already-voted cards
    document.querySelectorAll(".post").forEach((el) => {
      const postId = el.dataset.postId;
      if (el.classList.contains("sparkle-active")) {
        const engine = ensureSparkle(postId);
        if (engine) engine.start();
      }
    });

    window.addEventListener("resize", () => {
      sparkleEngines.forEach((engine) => engine.resize());
    });

    // ---------- vote/unvote ----------
    async function postJSON(url) {
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": CSRF,
          "X-Requested-With": "XMLHttpRequest",
          "Accept": "application/json",
        },
      });
      const data = await res.json().catch(() => ({}));
      return { res, data };
    }

    function setCardState(postId, voted) {
      const postEl = document.getElementById(`post-${postId}`);
      const btn = postEl.querySelector(".vote-btn");
      const engine = ensureSparkle(postId);

      if (voted) {
        postEl.classList.add("sparkle-active");
        postEl.classList.remove("dimmed");
        btn.classList.add("primary");
        btn.dataset.action = "unvote";
        btn.textContent = "{{ t('remove_vote') }}";
        if (engine) engine.start();
      } else {
        postEl.classList.remove("sparkle-active");
        postEl.classList.add("dimmed");
        btn.classList.remove("primary");
        btn.dataset.action = "vote";
        btn.textContent = "{{ t('vote') }}";
        if (engine) engine.stop();
      }
    }

    document.addEventListener("click", async (e) => {
      const btn = e.target.closest(".vote-btn");
      if (!btn) return;

      const postId = btn.dataset.postId;
      const action = btn.dataset.action;

      btn.disabled = true;

      try {
        const url = action === "vote" ? `/vote/${postId}` : `/unvote/${postId}`;
        const { res, data } = await postJSON(url);

        if (res.status === 401 && data && data.redirect) {
          showToast("{{ t('login_required') }}", "{{ t('login_to_continue') }}");
          setTimeout(() => { window.location.href = data.redirect; }, 700);
          return;
        }
        if (!res.ok || !data.ok) {
          showToast("{{ t('error') }}", "{{ t('try_again') }}");
          return;
        }

        // update count
        const vEl = document.getElementById(`votes-${postId}`);
        if (vEl && typeof data.votes !== "undefined") vEl.textContent = data.votes;

        setCardState(postId, data.voted);

        if (data.voted) {
          showToast("{{ t('voted') }}", "{{ t('your_vote_counted') }}");
        } else {
          showToast("{{ t('unvoted') }}", "{{ t('vote_removed') }}");
        }
      } catch (err) {
        showToast("{{ t('error') }}", "{{ t('try_again') }}");
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
